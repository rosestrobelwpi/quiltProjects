name: Debug Docker

on:
  workflow_dispatch:  # Allows manual run from GitHub Actions UI
  push:
    branches:
      - main
      - iteration1
      - iteration2
      - iteration3

jobs:
  debug-docker:
    runs-on: ubuntu-latest
    steps:
      - name: 🛠️ Checkout Code
        uses: actions/checkout@v4

      # 🔍 Check if GitHub Secrets are Set Correctly (Does not expose values)
      - name: 🔑 List GitHub Secrets (Without Exposing Values)
        run: |
          echo "Checking GitHub Secrets..."
          echo "===================================="
          echo "DOCKERHUB_USERNAME: ${DOCKERHUB_USERNAME:+SET}"
          echo "DOCKERHUB_PASSWORD: ${DOCKERHUB_PASSWORD:+SET}"
          echo "DOCKERHUB_REPO: ${DOCKERHUB_REPO:+SET}"
          echo "===================================="

      # 🔍 Check if Docker Hub Repo Exists
      - name: 🔍 Verify Docker Hub Repository Exists
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPO }}/")
          if [[ "$response" == "200" ]]; then
            echo "✅ Docker Hub repository exists!"
          else
            echo "❌ ERROR: Docker Hub repository does NOT exist or is private!"
            exit 1
          fi

      # 🔑 Test Docker Login
      - name: 🔑 Docker Login
        run: |
          echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # 🏗️ Build and Tag Docker Image (Temporary Debugging Tag)
      - name: 🏗️ Build Docker Image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPO }}:debug .

      # 🚀 Attempt to Push the Debug Tag to Docker Hub
      - name: 🚀 Try Pushing Docker Image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPO }}:debug || (echo "❌ ERROR: Docker Push Failed!" && exit 1)

      # ✅ Success Message
      - name: ✅ Completed Debugging
        run: echo "🎉 Debugging completed successfully!"


