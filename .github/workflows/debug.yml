name: Debug SSH Connection

on:
  workflow_dispatch:  # Allows manual triggering

jobs:
  debug-ssh:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Show First Few Characters of Private Key
        run: |
          echo "ğŸ” First few characters of EC2_SSH_KEY:"
          echo "${{ secrets.EC2_SSH_KEY }}" | head -n 3
          echo "âœ… If this looks incorrect, check your GitHub Secret formatting."

      - name: Check Private Key Formatting
        run: |
          echo "ğŸ” Checking private key line numbers:"
          echo "${{ secrets.EC2_SSH_KEY }}" | awk '{print NR " " $0}'
          echo "âœ… Ensure the key is **MULTILINE**, not a single line."

      - name: Set up SSH Key
        run: |
          echo "ğŸ” Writing private key..."
          echo "${{ secrets.EC2_SSH_KEY }}" | awk '{print}' > ec2_key.pem
          sed -i 's/\r$//' ec2_key.pem  # Remove Windows-style line endings
          chmod 600 ec2_key.pem
          ls -lah ec2_key.pem
          echo "âœ… Private Key Successfully Written!"
          echo "ğŸ” Previewing first few lines of the key:"
          cat ec2_key.pem | head -n 5

      - name: Test Private Key Validity
        run: |
          echo "ğŸ” Checking if SSH key is valid:"
          ssh-keygen -lf ec2_key.pem || echo "âŒ Invalid key! Check formatting."

      - name: Debug SSH Connection
        run: |
          echo "ğŸ” Testing SSH connection..."
          ssh -vvv -o StrictHostKeyChecking=no -i ec2_key.pem ec2-user@${{ secrets.EC2_HOST }} "echo 'SSH Connected Successfully!'" || echo "âŒ SSH failed!"
